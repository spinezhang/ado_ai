{% extends "base.html" %}

{% block title %}Settings - ADO AI{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900">Settings</h1>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-0" x-data="settingsManager()">
    <!-- Loading State -->
    <div x-show="loading" class="text-center py-12">
        <svg class="animate-spin h-12 w-12 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-600">Loading settings...</p>
    </div>

    <!-- Settings Form -->
    <div x-show="!loading" x-cloak class="bg-white shadow sm:rounded-lg p-6 max-w-4xl">
        <form @submit.prevent="saveSettings" class="space-y-8">

            <!-- Success Message -->
            <div x-show="success" class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-md" x-cloak>
                <p class="text-sm">âœ“ Settings saved successfully!</p>
            </div>

            <!-- Error Message -->
            <div x-show="error" class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-md" x-cloak>
                <p class="text-sm" x-text="error"></p>
            </div>

            <!-- Azure DevOps Section -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">Azure DevOps Configuration</h2>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Organization URL</label>
                    <input
                        type="text"
                        x-model="config.azure_devops_org_url"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"
                        readonly
                    >
                    <p class="mt-1 text-xs text-gray-500">Read-only - set during initial setup</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Project</label>
                    <input
                        type="text"
                        x-model="config.azure_devops_project"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"
                        readonly
                    >
                    <p class="mt-1 text-xs text-gray-500">Read-only - set during initial setup</p>
                </div>
            </div>

            <!-- AI Configuration -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">AI Configuration</h2>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Claude Model</label>
                    <select
                        x-model="config.claude_model"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"
                    >
                        <option value="claude-opus-4-6">Claude Opus 4.6 (Most Capable)</option>
                        <option value="claude-sonnet-4-5">Claude Sonnet 4.5 (Balanced)</option>
                        <option value="claude-haiku-4-5">Claude Haiku 4.5 (Fastest)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Max Tokens</label>
                    <input
                        type="number"
                        x-model="config.max_tokens"
                        min="100"
                        max="8192"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"
                    >
                    <p class="mt-1 text-xs text-gray-500">Maximum tokens for AI responses (100-8192)</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Temperature</label>
                    <input
                        type="number"
                        x-model="config.temperature"
                        min="0"
                        max="1"
                        step="0.1"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"
                    >
                    <p class="mt-1 text-xs text-gray-500">Creativity level (0.0 = deterministic, 1.0 = creative)</p>
                </div>
            </div>

            <!-- File Operations -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">File Operations</h2>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Work Folder Path</label>
                    <input
                        type="text"
                        x-model="config.work_folder_path"
                        placeholder="/path/to/workspace"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"
                    >
                    <p class="mt-1 text-xs text-gray-500">Base directory for file operations</p>
                </div>
            </div>

            <!-- Other Settings -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">Other Settings</h2>

                <div class="flex items-center">
                    <input
                        type="checkbox"
                        x-model="config.auto_approve"
                        id="auto_approve"
                        class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                    >
                    <label for="auto_approve" class="ml-2 block text-sm text-gray-900">
                        Auto-approve changes (skip confirmation prompts)
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-6 border-t">
                <button
                    type="submit"
                    :disabled="saving"
                    class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
                >
                    <span x-show="!saving">Save Changes</span>
                    <span x-show="saving" x-cloak>Saving...</span>
                </button>

                <a
                    href="/dashboard"
                    class="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
function settingsManager() {
    return {
        config: {
            azure_devops_org_url: '',
            azure_devops_project: '',
            claude_model: 'claude-opus-4-6',
            max_tokens: 4096,
            temperature: 0.7,
            work_folder_path: '',
            auto_approve: false
        },
        loading: true,
        saving: false,
        error: null,
        success: false,

        async init() {
            await this.loadSettings();
        },

        async loadSettings() {
            this.loading = true;
            this.error = null;

            try {
                const response = await fetch('/api/config');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to load settings');
                }

                this.config = data;
                console.log('Settings loaded:', data);

            } catch (err) {
                this.error = err.message;
                console.error('Load error:', err);
            } finally {
                this.loading = false;
            }
        },

        async saveSettings() {
            this.saving = true;
            this.error = null;
            this.success = false;

            try {
                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        claude_model: this.config.claude_model,
                        max_tokens: parseInt(this.config.max_tokens),
                        temperature: parseFloat(this.config.temperature),
                        work_folder_path: this.config.work_folder_path || null,
                        auto_approve: this.config.auto_approve
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to save settings');
                }

                this.success = true;
                console.log('Settings saved:', data);

                // Hide success message after 3 seconds
                setTimeout(() => {
                    this.success = false;
                }, 3000);

            } catch (err) {
                this.error = err.message;
                console.error('Save error:', err);
            } finally {
                this.saving = false;
            }
        }
    }
}
</script>
{% endblock %}

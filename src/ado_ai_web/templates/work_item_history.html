{% extends "base.html" %}

{% block title %}Analysis Result - ADO AI{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900">Analysis Result</h1>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-0" x-data="historyViewer()" x-init="loadHistory()">
    <!-- Loading State -->
    <div x-show="loading" class="bg-white shadow sm:rounded-lg p-6 text-center">
        <svg class="animate-spin h-12 w-12 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-600">Loading analysis...</p>
    </div>

    <!-- Error State -->
    <div x-show="error && !loading" class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-md mb-6" x-cloak>
        <p class="text-sm" x-text="error"></p>
    </div>

    <!-- Work Item Details -->
    <div x-show="!loading && history" class="bg-white shadow sm:rounded-lg p-6 mb-6" x-cloak>
        <h2 class="text-lg font-medium text-gray-900 mb-4">Work Item Information</h2>

        <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
            <div>
                <dt class="text-sm font-medium text-gray-500">ID</dt>
                <dd class="mt-1 text-sm text-gray-900" x-text="history?.work_item_id"></dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Type</dt>
                <dd class="mt-1 text-sm text-gray-900" x-text="history?.work_item_type"></dd>
            </div>
            <div class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Title</dt>
                <dd class="mt-1 text-sm text-gray-900 font-semibold" x-text="history?.title"></dd>
            </div>
            <div x-show="history?.custom_prompt" class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Custom Prompt</dt>
                <dd class="mt-1 text-sm text-gray-700 bg-blue-50 p-3 rounded-md" x-text="history?.custom_prompt"></dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Status</dt>
                <dd class="mt-1">
                    <span class="px-2 py-1 text-xs font-medium rounded-full"
                          :class="{
                              'bg-green-100 text-green-800': history?.status === 'completed',
                              'bg-yellow-100 text-yellow-800': history?.status === 'analyzing',
                              'bg-red-100 text-red-800': history?.status === 'failed'
                          }"
                          x-text="history?.status"></span>
                </dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Analyzed At</dt>
                <dd class="mt-1 text-sm text-gray-900" x-text="history?.created_at ? new Date(history.created_at).toLocaleString() : ''"></dd>
            </div>
        </dl>
    </div>

    <!-- Analysis Results -->
    <div x-show="!loading && history?.analysis_result" class="bg-white shadow sm:rounded-lg p-6" x-cloak>
        <h2 class="text-lg font-medium text-gray-900 mb-4">‚ú® AI Analysis Results</h2>

        <div class="space-y-6">
            <!-- Analysis -->
            <div>
                <h3 class="text-sm font-semibold text-gray-900 mb-2">Analysis</h3>
                <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="history?.analysis_result?.analysis"></p>
            </div>

            <!-- Solution -->
            <div>
                <h3 class="text-sm font-semibold text-gray-900 mb-2">Solution</h3>
                <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="history?.analysis_result?.solution"></p>
            </div>

            <!-- Tasks -->
            <div x-show="history?.analysis_result?.tasks && history.analysis_result.tasks.length > 0">
                <h3 class="text-sm font-semibold text-gray-900 mb-2">Tasks</h3>
                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                    <template x-for="(task, index) in history?.analysis_result?.tasks" :key="index">
                        <li x-text="task"></li>
                    </template>
                </ul>
            </div>

            <!-- Risks -->
            <div x-show="history?.analysis_result?.risks && history.analysis_result.risks.length > 0" class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                <h3 class="text-sm font-semibold text-yellow-900 mb-2">‚ö†Ô∏è Risks & Considerations</h3>
                <ul class="list-disc list-inside text-sm text-yellow-800 space-y-1">
                    <template x-for="(risk, index) in history?.analysis_result?.risks" :key="index">
                        <li x-text="risk"></li>
                    </template>
                </ul>
            </div>

            <!-- Proposed Changes -->
            <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                <h3 class="text-sm font-semibold text-blue-900 mb-2">üí° Proposed Changes</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li x-show="history?.analysis_result?.suggested_status">
                        <strong>Status:</strong> <span x-text="history?.analysis_result?.suggested_status"></span>
                    </li>
                    <li x-show="history?.analysis_result?.suggested_remaining_work">
                        <strong>Remaining Work:</strong> <span x-text="history?.analysis_result?.suggested_remaining_work"></span> hours
                    </li>
                    <li x-show="history?.analysis_result?.comment">
                        <strong>Comment:</strong> <span x-text="history?.analysis_result?.comment"></span>
                    </li>
                </ul>
            </div>

            <!-- File Changes -->
            <div x-show="history?.analysis_result?.file_changes && history.analysis_result.file_changes.length > 0" class="bg-green-50 border border-green-200 rounded-md p-4">
                <h3 class="text-sm font-semibold text-green-900 mb-2">üìù File Changes</h3>
                <div class="space-y-2">
                    <template x-for="(file, index) in history?.analysis_result?.file_changes" :key="index">
                        <div class="bg-white border border-green-200 rounded p-3">
                            <div class="flex items-start justify-between mb-2">
                                <div>
                                    <p class="text-sm font-mono font-medium text-green-900" x-text="file.path"></p>
                                    <p class="text-xs text-green-700 mt-1" x-text="file.description"></p>
                                </div>
                            </div>
                            <details class="mt-2">
                                <summary class="text-xs text-green-700 cursor-pointer hover:text-green-900">View content</summary>
                                <pre class="mt-2 text-xs bg-gray-50 p-2 rounded overflow-x-auto max-h-64"><code x-text="file.content"></code></pre>
                            </details>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Cost -->
            <div x-show="history?.cost" class="text-sm text-gray-600">
                <strong>üí∞ Cost:</strong> $<span x-text="history?.cost?.toFixed(4)"></span>
                <span x-show="history?.token_usage">
                    (<span x-text="history?.token_usage?.input_tokens?.toLocaleString()"></span> input,
                    <span x-text="history?.token_usage?.output_tokens?.toLocaleString()"></span> output tokens)
                </span>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4 border-t">
                <a href="/dashboard" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    ‚Üê Back to Dashboard
                </a>
                <button x-show="history?.analysis_result?.file_changes && history.analysis_result.file_changes.length > 0 && history?.work_folder_path"
                        @click="applyFileChanges()"
                        :disabled="applyingFiles"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!applyingFiles">‚úì Apply File Changes</span>
                    <span x-show="applyingFiles">Applying...</span>
                </button>
            </div>

            <!-- Apply Result -->
            <div x-show="applyResult" x-cloak class="mt-4">
                <div :class="applyResult?.success ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'" class="border rounded-md p-4">
                    <h4 class="text-sm font-semibold mb-2" x-text="applyResult?.success ? '‚úì Files Applied Successfully' : '‚ùå Some Files Failed'"></h4>
                    <p class="text-sm mb-2">
                        Work folder: <span class="font-mono" x-text="applyResult?.work_folder"></span>
                    </p>
                    <p class="text-sm mb-2">
                        <span x-text="applyResult?.files_succeeded"></span> of <span x-text="applyResult?.files_processed"></span> files applied successfully
                    </p>
                    <template x-if="applyResult?.results && applyResult.results.length > 0">
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <template x-for="(result, index) in applyResult?.results" :key="index">
                                <li>
                                    <span x-text="result.success ? '‚úì' : '‚úó'"></span>
                                    <span class="font-mono" x-text="result.path"></span>
                                    <span x-show="!result.success" class="text-xs" x-text="'- ' + result.error"></span>
                                </li>
                            </template>
                        </ul>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Failed State -->
    <div x-show="!loading && history?.status === 'failed'" class="bg-red-50 border border-red-200 rounded-md p-6" x-cloak>
        <h3 class="text-sm font-semibold text-red-900 mb-2">‚ùå Analysis Failed</h3>
        <p class="text-sm text-red-800" x-text="history?.error_message || 'An error occurred during analysis'"></p>

        <div class="mt-4">
            <a :href="`/work-items/new?id=${history?.work_item_id}`" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                Try Again
            </a>
        </div>
    </div>
</div>

<script>
function historyViewer() {
    return {
        history: null,
        loading: true,
        error: null,
        applyingFiles: false,
        applyResult: null,

        async loadHistory() {
            // Get history ID from URL
            const pathParts = window.location.pathname.split('/');
            const historyId = pathParts[pathParts.length - 1];

            if (!historyId || historyId === 'history') {
                this.error = 'No history ID provided';
                this.loading = false;
                return;
            }

            this.loading = true;
            try {
                const response = await fetch(`/api/work-items/history/${historyId}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to load history');
                }

                this.history = data;
                console.log('Loaded history:', data);

            } catch (err) {
                this.error = err.message;
                console.error('Load error:', err);
            } finally {
                this.loading = false;
            }
        },

        async applyFileChanges() {
            const pathParts = window.location.pathname.split('/');
            const historyId = pathParts[pathParts.length - 1];

            if (!confirm('Are you sure you want to apply these file changes? This will overwrite existing files.')) {
                return;
            }

            this.applyingFiles = true;
            this.applyResult = null;

            try {
                const response = await fetch(`/api/work-items/history/${historyId}/apply-files`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to apply file changes');
                }

                this.applyResult = data;
                console.log('Apply result:', data);

            } catch (err) {
                this.applyResult = {
                    success: false,
                    error: err.message,
                    files_processed: 0,
                    files_succeeded: 0,
                    files_failed: 0
                };
                console.error('Apply error:', err);
            } finally {
                this.applyingFiles = false;
            }
        }
    }
}
</script>
{% endblock %}
